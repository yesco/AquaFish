<!doctype html>
<!-- http://webcamtest.davidhunterdesign.com/motion_bubbles.html -->
<head>
<title>Motion Bubbles</title>
<style>
    #vid {
        display:none;
    }
    #canvas {
        width:100%;
        height:100%;
    }
    #toggle {
        position: fixed;
        right: 0;
        bottom: 0;
    }
    </style>

</head>
<body>
	<video autoplay id="vid"></video>
<canvas id="canvas" width="640" height="480"></canvas><br>
<button onclick="toggleColours()" id="toggle">Toggle Colours</button>

<script type="text/javascript">
    var video = document.querySelector("#vid");
    var canvas = document.querySelector('#canvas');
    var ctx = canvas.getContext('2d');
    var localMediaStream = null;

    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var prevImageData = ctx.getImageData(0,0,canvas.width,canvas.height);

    // modify this to set grid size of detection
    var size = 30;
 
    var threshold = 200;

    // essentially draw a circle using ctx.arc
    var startPoint = (Math.PI/180)*0;
    var endPoint = (Math.PI/180)*360;

    var bubbles = new Array();
    var firstRun = true;

    // BALL CLASS
    function Ball(n) {
        this.id = n;
        this.x = 0;
        this.y = 0;
        this.life = 20;
        this.r = 0;
        this.g = 0;
        this.b = 0;
    }

    Ball.prototype.update = function(id) {
        this.life-= 0.3;
        // remove if life expired
        if (this.life <= 0) bubbles.splice(id,1)
    }

    var onCameraFail = function (e) {
        console.log('Camera did not work.', e);
    };

    function getPixel2(imageData, prevImageData, x, y) {
        var cr, cg, cb, ca, pr, pg, pb, pa, offset = x * 4 + y * 4 * imageData.width;

        cr = imageData.data[offset];
        cg = imageData.data[offset + 1];
        cb = imageData.data[offset + 2];
        ca = imageData.data[offset + 3];

        pr = prevImageData.data[offset];
        pg = prevImageData.data[offset + 1];
        pb = prevImageData.data[offset + 2];
        pa = prevImageData.data[offset + 3];

        var diff = Math.abs(pr-cr) + Math.abs(pg-cg) + Math.abs(pb-cb);

        var obj = new Object();
        obj.d = diff;
        if (diff > threshold) {
            obj.r = cr;
            obj.g = cg;
            obj.b = cb;
        } else {
            obj.r = 555;
            obj.g = 555;
            obj.b = 555;
        }

        return obj;
    }

    function motionDetect() {
        imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        ctx.clearRect(0,0,canvas.width, canvas.height);

    if(!firstRun) {
        var x, y;
        for(x = 0; x < canvas.width; x += size) {
            for(y = 0; y < canvas.height; y += size) {
               var cob = getPixel2(imageData, prevImageData, x, y);
               //console.log(cob.g);

               if (cob.d > threshold) {
                   var b = new Ball(0);
                   b.x = x;
                   b.y = y;
                   b.r = 255; // x/2;
                   //b.g = y/2;
                   //b.b = 153;
                   b.life = cob.d/40;
                   bubbles.push(b);
               }
           }
        }
        }
        // update previous frame image data
        prevImageData = imageData;
        firstRun = false;
    }

    // draw bubbles
    function render() {
        for(var i=0; i<bubbles.length; i++) {
            var b = bubbles[i];

            ctx.fillStyle = "rgba(" + b.r + "," + b.g + "," + b.b + "," + 255 + ")";
            ctx.beginPath();
            ctx.arc(b.x,b.y,b.life, startPoint, endPoint, true);
            ctx.fill();
            ctx.closePath();

            b.update(i);
        }
    }

   function draw(obj, context) {
     context.drawImage(obj, 0, 0);
     motionDetect();
     render();
   }
   
   // use timer, uses constant CPU
   function drawVideoAtCanvas(obj, context) {
        window.setInterval(function() { 
            draw(obj, context);
        }, 60);
    }

    // automatic, called as often as possible
    function update(obj, context) {
        draw(obj, context);
        requestAnimationFrame( function() { update(video,ctx) } );
    }

    //video.addEventListener('play', function() { drawVideoAtCanvas(video, ctx) }, false);
    video.addEventListener('play', function() { update(video, ctx) }, false);

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL;
    navigator.getUserMedia({video:true}, function (stream) {
        video.src = window.URL.createObjectURL(stream);
        localMediaStream = stream;
    }, onCameraFail);

</script>
</body>

</html>
